{% extends 'forum/base.html' %}

{% block content %}

<div class="container mt-4">
    <h2>{{ post.title }}</h2>
    <div class="col-md-3">
        <img src="{{ post.image.url }}" class="img-fluid" alt="{{ post.title }}">
    </div>

    <div class="mt-3">
        <p>‚ù§Ô∏è <span id="like-count">{{ post.likes.count }}</span> –ª–∞–π–∫–æ–≤</p>

        {% if user.is_authenticated %}
            <button id="like-button" class="btn {% if user_liked %}btn-outline-danger{% else %}btn-outline-success{% endif %}"
                    data-post-id="{{ post.id }}">
                {% if user_liked %}–£–±—Ä–∞—Ç—å –ª–∞–π–∫ üëé{% else %}–ü–æ—Å—Ç–∞–≤–∏—Ç—å –ª–∞–π–∫ üëç{% endif %}
            </button>
        {% else %}
            <p class="text-muted">–ß—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤–∏—Ç—å –ª–∞–π–∫, <a href="{% url 'login' %}">–≤–æ–π–¥–∏—Ç–µ</a>.</p>
        {% endif %}
    </div>

    <hr>
    <h4>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h4>

    {% for comment in comments %}
        <div class="mb-3 p-3 border rounded">
            <strong>{{ comment.user.username }}</strong> <small class="text-muted">{{ comment.created_at|date:"d.m.Y H:i" }}</small>
            <p class="mt-2 mb-0">{{ comment.text }}</p>
        </div>
    {% empty %}
        <p>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>
    {% endfor %}

    {% if user.is_authenticated %}
        <hr>
        <h5>–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h5>
        <form method="post">
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </form>
    {% else %}
        <p class="text-muted">–ß—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, <a href="{% url 'login' %}">–≤–æ–π–¥–∏—Ç–µ</a>.</p>
    {% endif %}
</div>
{% endblock %}




<script>
    document.addEventListener('DOMContentLoaded', function() {
        const likeButton = document.getElementById('like-button');
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;

        if (!likeButton || !csrfToken) return;

        likeButton.addEventListener('click', function() {
            const postId = this.dataset.postId;

            fetch(`/toggle_like/${postId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                },
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('like-count').textContent = data.likes_count;

                if (data.liked) {
                    likeButton.textContent = '–£–±—Ä–∞—Ç—å –ª–∞–π–∫ üëé';
                    likeButton.classList.remove('btn-outline-success');
                    likeButton.classList.add('btn-outline-danger');
                } else {
                    likeButton.textContent = '–ü–æ—Å—Ç–∞–≤–∏—Ç—å –ª–∞–π–∫ üëç';
                    likeButton.classList.remove('btn-outline-danger');
                    likeButton.classList.add('btn-outline-success');
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ª–∞–π–∫–∞:', error);
            });
        });
    });
</script>